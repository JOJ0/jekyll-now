---
layout: post
title: Building MIDI controllers &#x23;1 - The Matrix
comments: true
published: 2018-11-23
image: /images/2018-11-17-midictrl1/IMG_XXXX.jpg
draft: true
---

MIDI controllers are not the most complicated things to build and program. If you have your MIDI basics covered and have a little experience with Arduino-type microcontrollers it's just a matter of capturing an inputdevice (button, knob, ...) into your microcontroller and sending some bytes out via a serial port, which MIDI essentially is.

There is a lot about building basic MIDI controllers on the net already so I won't cover that, but give an overview of what helped me to get going last year:

  * [This](https://www.youtube.com/watch?v=0L7WAMFWSgY&index=80&t=0s&list=PLcHqk0rpp8br1wTI-LeNKtxVmEKB1YT8O) is probably the best explanation of how MIDI circuits really work from an electrical point of view.
  * [This basic MIDI controllers tutorial](https://www.youtube.com/watch?v=DXhxdsGREsU) is from the same guy but unfortunately he doesn't explain much how it actually works, you won't learn coding with this one.
  * [Video series ](https://www.youtube.com/playlist?list=PL8ANKYeWEXshCLOS9sFfcQNigYXEb1Ps6) in german language for absolute beginners without any Arduino experience. Also he doesn't use any libraries but explains how to do everything from scratch. Valuable!
  * [This video](https://www.youtube.com/watch?v=aVf_el4N0tI&t=54s) is quite nice, he's using a Teensy microcontroller which has MIDI over USB by default

Speaking of: just to get one slightly dissapointing thing straight from the beginning: Most of the common Arduino types are not capable of natively spitting out MIDI on their USB ports, but I'm going to show a hardware-hackish approach to still make it work. A few Arduinos have native USB capabilities and can make use of the [MIDIUSB library](https://github.com/arduino-libraries/MIDIUSB) , but that's usually the type of Arduino you don't have at hand at the right moment. The only one's that have USB-MIDI out of the box are the Teensy's but they cost a little more, if you don't want any hassle go get one! [This is the website of the founder](https://www.pjrc.com/teensy/), you'll find excellent documentation there.


## The input device

This is going to be my chosen input device, a button matrix out of a 1995 landline phone, built by the company Kapsch, model TP80.

<div class="clearfix" style="margin-bottom: 20px;">
{% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-01.jpg' caption='I got these phone parts out of a spare parts collection' width="49%" float="left" %}
{% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-02.jpg' caption='There was another PCB connected to the actual buttons PCB that had to be desoldered first' width="49%" float="right" %}
</div>

<a name="understanding">
### Understanding

So wtf is a key matrix? [This guy](https://www.youtube.com/watch?v=DlW77pAyDx4&t=1s&list=PLcHqk0rpp8br1wTI-LeNKtxVmEKB1YT8O&index=5) explains it quite well, just ignore the voltage ladder for now. [The german speaking guy over here](https://www.youtube.com/watch?v=vaqzTHOvpH8&t=1604s&list=PLcHqk0rpp8br1wTI-LeNKtxVmEKB1YT8O&index=10), altough a bit more advanced, is explaining useful things too. He uses a button matrix out of an old chipcard terminal.

Personally my first experience with a button/keyboard matrix was the tiny 80s keyboard featured in [one of my blog posts]({% post_url 2017-12-26-yamaha-ps-1 %}). I found a lot of information about a similar keyboard on [this website](http://weltenschule.de/TableHooters/Yamaha_PS-2.html). The site owner even has put together a whole [FAQ](http://weltenschule.de/TableHooters/WarrantyVoidFAQ.htm) about circuit bending and especially hacking keyboards. Scroll down a little (well a lot, it's long) and look for headlines containing keyboard matrix. Deadly useful information there!!! 

If it still all doesn't add up, check [this](http://pcbheaven.com/wikipages/How_Key_Matrices_Works/) and certainly [wikipedia](https://en.wikipedia.org/wiki/Keyboard_matrix_circuit)

### Measuring

<div class="pic_row_3">
  <div class="pic_left">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-03.jpg' caption='The top 3 connections are labeled by a letter X, the bottom 4 with a letter Y. Ignore the red wire on the very bottom.' %}
  </div>
  <div class="pic_middle">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-04.jpg' caption='No buttons pressed - no connections, but when button 1 is pressed X1 to Y1 show a connection.' %}
  </div>
  <div class="pic_right">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-05.jpg' caption='X2 to Y1 is connected when button 2 is pressed' %}
  </div>
</div>

<div class="pic_row_3">
  <div class="pic_left">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-06.jpg' caption='X3 to Y1 is connected when button 3 is pressed' %}
  </div>
  <div class="pic_middle">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-07.jpg' caption='X1 to Y2 is connected when button 4 is pressed' %}
  </div>
  <div class="pic_right">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-08.jpg' caption='X2 to Y2 is connected when button 5 is pressed' %}
  </div>
</div>


I guess you see where this is going by now. If not, go back and rewatch the youtube videos an links posted [above](#understanding).

<a name="housing">
## Housing

Before I started with writing code, I did some fitting to the case I was planning to put it in. I found this in my parent's basement. Eventually I built it myself during my apprenticeship back in the 90ies. As far as I remember it should have become a battery powered radio and due to time reasons we never even started to build the electronics.

<div class="pic_row_3">
  <div class="pic_left">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-09.jpg' caption="These holes should have been the outlet for the speaker's sound." %}
  </div>
  <div class="pic_middle">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-10.jpg' caption="On the inside we had to construct this battery holder. Won't use it but won't remove it, it's glued in there and seems pretty steady." %}
  </div>
  <div class="pic_right">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-11.jpg' caption="The keypad should sit on top of it, the MC inside the box." %}
  </div>
</div>

<div class="pic_row_3">
  <div class="pic_left">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-12.jpg' caption="It just fits's perfectly on top of it. How nice is that? At first I thought I have to remove the boxes lid and couldn't think of a possibility to then steadily mount the keypad, but after some head-scratching I had a better idea..." %}
  </div>
  <div class="pic_middle">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-13.jpg' caption="I replaced the original wires with new ones, but soldered them to the PCB upside-down, so they take as little space as possible underneath the keypad's PCB" %}
  </div>
  <div class="pic_right">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-14.jpg' caption="The wires should be slipping into the speaker holes, ..." %}
  </div>
</div>

<div class="pic_row_3">
  <div class="pic_left">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-15.jpg' caption="...so the PCB can be sticked to the box with hot-glue. The double-sided scotch tape was kind of a proof of concept." %}
  </div>
  <div class="pic_middle">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-16.jpg' caption="Bougth these to be able to steadily close the lid. Lost the original ones or never had them." %}
  </div>
  <div class="pic_right">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-17.jpg' caption="Drilled the holes a little bigger, to make the screws fit, ..." %}
  </div>
</div>


<div class="pic_row_3">
  <div class="pic_left">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-18.jpg' caption="...and used this handy tool out of my girlfriend's stash to make the screw-heads even with the housing again." %}
  </div>
  <div class="pic_middle">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-19.jpg' caption="Et voila, finally the box can be properly closed." %}
  </div>
  <div class="pic_right">
  </div>
</div>

<a name="coding">
## Coding
<a name="breadboarding">
### Breadboarding setup

<div class="pic_row_3">
  <div class="pic_left">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-20.jpg' caption="Soldered a pin-header to an Arduino Nano. Didn't use the double-row header, so it still fits into the breadboard!" %}
  </div>
  <div class="pic_middle">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-21.jpg' caption="The 3 X wires (cols) and the 4 Y wires (rows) connected to the breadboard." %}
  </div>
  <div class="pic_right">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-22.jpg' caption="Digital pins 6-8 used as outputs (cols, X), digital pins 9-12 used as inputs (rows, Y). Some 10-15k pull-down resistors to keep LOW level when no buttons are pressed." %}
  </div>
</div>

<div class="pic_row_3">
  <div class="pic_left">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-23.jpg' caption="Much later on I decided to get rid of the pull-down resistors by making everything low-active. More on that further below..." %}
  </div>
  <div class="pic_middle">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-24.jpg' caption="Had to fix the matrix, for some reason in the last row two pins where not connected." %}
  </div>
  <div class="pic_right">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-25.jpg' caption="Here used to be a jumper which could be set to change the phones behaviour. I just hard-wired it to stay closed." %}
  </div>
</div>


<a name="receiving">
### Receiving the input

note:
first:
yes it's high: 0 0
last:
yes it's high: 2 3


code blabla here

<a name="usb-midi">
## Finalizing

### The cheapest USB-MIDI-Arduino available

<div class="pic_row_3">
  <div class="pic_left">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-26.jpg' caption="" %}
  </div>
  <div class="pic_middle">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-27.jpg' caption="" %}
  </div>
  <div class="pic_right">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-28.jpg' caption="" %}
  </div>
</div>

<div class="pic_row_3">
  <div class="pic_left">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-29.jpg' caption="" %}
  </div>
  <div class="pic_middle">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-30.jpg' caption="" %}
  </div>
  <div class="pic_right">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-31.jpg' caption="" %}
  </div>
</div>

<div class="pic_row_3">
  <div class="pic_left">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-32.jpg' caption="" %}
  </div>
  <div class="pic_middle">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-33.jpg' caption="" %}
  </div>
  <div class="pic_right">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-34.jpg' caption="" %}
  </div>
</div>

<div class="pic_row_3">
  <div class="pic_left">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-35.jpg' caption="" %}
  </div>
  <div class="pic_middle">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-36.jpg' caption="" %}
  </div>
  <div class="pic_right">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-37.jpg' caption="" %}
  </div>
</div>

<div class="pic_row_3">
  <div class="pic_left">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-38.jpg' caption="" %}
  </div>
  <div class="pic_middle">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-39.jpg' caption="" %}
  </div>
  <div class="pic_right">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-40.jpg' caption="" %}
  </div>
</div>


<div class="pic_row_3">
  <div class="pic_left">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-41.jpg' caption="" %}
  </div>
  <div class="pic_middle">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-42.jpg' caption="" %}
  </div>
  <div class="pic_right">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-43.jpg' caption="" %}
  </div>
</div>

<div class="pic_row_3">
  <div class="pic_left">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-44.jpg' caption="" %}
  </div>
  <div class="pic_middle">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-45.jpg' caption="" %}
  </div>
  <div class="pic_right">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-46.jpg' caption="" %}
  </div>
</div>

<div class="pic_row_3">
  <div class="pic_left">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-47.jpg' caption="" %}
  </div>
  <div class="pic_middle">
  </div>
  <div class="pic_right">
  </div>
</div>

<a name="testrun">
### Testrun

<div class="pic_row_3">
  <div class="pic_left">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-48.jpg' caption="" %}
  </div>
  <div class="pic_middle">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-49.jpg' caption="" %}
  </div>
  <div class="pic_right">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-50.jpg' caption="" %}
  </div>
</div>


<a name="fancy">
### Making it even fancier

<div class="pic_row_3">
  <div class="pic_left">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-51.jpg' caption="" %}
  </div>
  <div class="pic_middle">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-52.jpg' caption="" %}
  </div>
  <div class="pic_right">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-53.jpg' caption="" %}
  </div>
</div>

<div class="pic_row_3">
  <div class="pic_left">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-54.jpg' caption="" %}
  </div>
  <div class="pic_middle">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-55.jpg' caption="" %}
  </div>
  <div class="pic_right">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-55.jpg' caption="" %}
  </div>
</div>

<div class="pic_row_3">
  <div class="pic_left">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-56.jpg' caption="" %}
  </div>
  <div class="pic_middle">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-57.jpg' caption="" %}
  </div>
  <div class="pic_right">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-58.jpg' caption="" %}
  </div>
</div>

<div class="pic_row_3">
  <div class="pic_left">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-59.jpg' caption="" %}
  </div>
  <div class="pic_middle">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-60.jpg' caption="" %}
  </div>
  <div class="pic_right">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-61.jpg' caption="" %}
  </div>
</div>

<div class="pic_row_3">
  <div class="pic_left">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-62.jpg' caption="" %}
  </div>
  <div class="pic_middle">
  </div>
  <div class="pic_right">
  </div>
</div>

3 pics in a row template here:
<div class="pic_row_3">
  <div class="pic_left">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-xx.jpg' caption="" %}
  </div>
  <div class="pic_middle">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-xx.jpg' caption="" %}
  </div>
  <div class="pic_right">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-xx.jpg' caption="" %}
  </div>
</div>



blinking LEDs video here:

{% include youtube.html id="xxxxxxx" url_append="?start=2490" width="100%" %}
text unter youtube
<br><br>

### Getting materials

[20 pin inline socket](https://www.musikding.de/20-Pin-inline-socket)<br>
