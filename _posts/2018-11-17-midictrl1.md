---
layout: post
title: Building MIDI controllers &#x23;1 - The Matrix
comments: true
published: 2018-11-23
image: /images/2018-11-17-midictrl1/IMG_XXXX.jpg
draft: true
---

MIDI controllers are not the most complicated things to build and program. If you have your MIDI basics covered and have a little experience with Arduino-type microcontrollers it's just a matter of capturing an inputdevice (button, knob, ...) into your microcontroller and sending some bytes out via a serial port, which MIDI essentially is.

There is a lot about building basic MIDI controllers on the net already so I won't cover that, but give an overview of what helped me to get going last year:

  * [This](https://www.youtube.com/watch?v=0L7WAMFWSgY&index=80&t=0s&list=PLcHqk0rpp8br1wTI-LeNKtxVmEKB1YT8O) is probably the best explanation of how MIDI circuits really work from an electrical point of view.
  * [This basic MIDI controllers tutorial](https://www.youtube.com/watch?v=DXhxdsGREsU) is from the same guy but unfortunately he doesn't explain much how it actually works, you won't learn coding with this one.
  * [Video series ](https://www.youtube.com/playlist?list=PL8ANKYeWEXshCLOS9sFfcQNigYXEb1Ps6) in german language for absolute beginners without any Arduino experience. Also he doesn't use any libraries but explains how to do everything from scratch. Valuable!
  * [This video](https://www.youtube.com/watch?v=aVf_el4N0tI&t=54s) is quite nice, he's using a Teensy microcontroller which has MIDI over USB by default

Speaking of: just to get one slightly dissapointing thing straight from the beginning: Most of the common Arduino types are not capable of natively spitting out MIDI on their USB ports, but I'm going to show a hardware-hackish approach to still make it work. A few Arduinos have native USB capabilities and can make use of the [MIDIUSB library](https://github.com/arduino-libraries/MIDIUSB) , but that's usually the type of Arduino you don't have at hand at the right moment. The only one's that have USB-MIDI out of the box are the Teensy's but they cost a little more, if you don't want any hassle go get one! [This is the website of the founder](https://www.pjrc.com/teensy/), you'll find excellent documentation there.


## The input device

This is going to be my chosen input device, a button matrix out of a 1995 landline phone, built by the company Kapsch, model TP80.

<div class="clearfix" style="margin-bottom: 20px;">
{% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-01.jpg' caption='I got these phone parts out of a spare parts collection' width="49%" float="left" %}
{% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-02.jpg' caption='There was another PCB connected to the actual buttons PCB that had to be desoldered first' width="49%" float="right" %}
</div>

<a name="understanding">
### Understanding

So wtf is a key matrix? [This guy](https://www.youtube.com/watch?v=DlW77pAyDx4&t=1s&list=PLcHqk0rpp8br1wTI-LeNKtxVmEKB1YT8O&index=5) explains it quite well, just ignore the voltage ladder for now. [The german speaking guy over here](https://www.youtube.com/watch?v=vaqzTHOvpH8&t=1604s&list=PLcHqk0rpp8br1wTI-LeNKtxVmEKB1YT8O&index=10), altough a bit more advanced, is explaining useful things too. He uses a button matrix out of an old chipcard terminal.

Personally my first experience with a button/keyboard matrix was the tiny 80s keyboard featured in [one of my blog posts]({% post_url 2017-12-26-yamaha-ps-1 %}). I found a lot of information about a similar keyboard on [this website](http://weltenschule.de/TableHooters/Yamaha_PS-2.html). The site owner even has put together a whole [FAQ](http://weltenschule.de/TableHooters/WarrantyVoidFAQ.htm) about circuit bending and especially hacking keyboards. Scroll down a little (well a lot, it's long) and look for headlines containing keyboard matrix. Deadly useful information there!!! 

If it still all doesn't add up, check [this](http://pcbheaven.com/wikipages/How_Key_Matrices_Works/) and certainly [wikipedia](https://en.wikipedia.org/wiki/Keyboard_matrix_circuit)

### Measuring

<div class="pic_row_3">
  <div class="pic_left">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-03.jpg' caption='The top 3 connections are labeled by a letter X, the bottom 4 with a letter Y. Ignore the red wire on the very bottom.' %}
  </div>
  <div class="pic_middle">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-04.jpg' caption='No buttons pressed - no connections, but when button 1 is pressed X1 to Y1 show a connection.' %}
  </div>
  <div class="pic_right">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-05.jpg' caption='X2 to Y1 is connected when button 2 is pressed' %}
  </div>
</div>

<div class="pic_row_3">
  <div class="pic_left">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-06.jpg' caption='X3 to Y1 is connected when button 3 is pressed' %}
  </div>
  <div class="pic_middle">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-07.jpg' caption='X1 to Y2 is connected when button 4 is pressed' %}
  </div>
  <div class="pic_right">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-08.jpg' caption='X2 to Y2 is connected when button 5 is pressed' %}
  </div>
</div>


I guess you see where this is going by now. If not, go back and rewatch the youtube videos an links posted [above](#understanding). Ok, so we can think of our matrix that it has 3 column lines, the X-wires, and 4 row lines, the Y-wires.

<a name="housing">
## Housing

Before I started with writing code, I did some fitting to the case I was planning to put it in. I found this in my parent's basement. Eventually I built it myself during my apprenticeship back in the 90ies. As far as I remember it should have become a battery powered radio and due to time reasons we never even started to build the electronics.

<div class="pic_row_3">
  <div class="pic_left">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-09.jpg' caption="These holes should have been the outlet for the speaker's sound." %}
  </div>
  <div class="pic_middle">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-10.jpg' caption="On the inside we had to construct this battery holder. Won't use it but won't remove it, it's glued in there and seems pretty steady." %}
  </div>
  <div class="pic_right">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-11.jpg' caption="The keypad should sit on top of it, the MC inside the box." %}
  </div>
</div>

<div class="pic_row_3">
  <div class="pic_left">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-12.jpg' caption="It just fits's perfectly on top of it. How nice is that? At first I thought I have to remove the boxes lid and couldn't think of a possibility to then steadily mount the keypad, but after some head-scratching I had a better idea..." %}
  </div>
  <div class="pic_middle">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-13.jpg' caption="I replaced the original wires with new ones, but soldered them to the PCB upside-down, so they take as little space as possible underneath the keypad's PCB" %}
  </div>
  <div class="pic_right">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-15.jpg' caption="The wires should be slipping into the speaker holes, so the PCB can be sticked to the box with hot-glue. The double-sided scotch tape was kind of a proof of concept." %}
  </div>
</div>

<div class="pic_row_3">
  <div class="pic_left">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-16.jpg' caption="Bougth these to be able to steadily close the lid. Lost the original ones or never had them." %}
  </div>
  <div class="pic_middle">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-18.jpg' caption="Redrilled and used this handy tool, out of my girlfriend's stash, to make the screws fit and the screw-heads even with the housing again." %}
  </div>
  <div class="pic_right">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-19.jpg' caption="Et voila, finally the box can be properly closed." %}
  </div>
</div>


<div class="pic_row_3">
  <div class="pic_left">
  </div>
  <div class="pic_middle">
  </div>
  <div class="pic_right">
  </div>
</div>

<a name="coding">
## Writing code
<a name="breadboarding">
### Breadboarding

<div class="pic_row_3">
  <div class="pic_left">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-20.jpg' caption="Soldered a pin-header to an Arduino Nano. Didn't use the double-row header, so it still fits into the breadboard!" %}
  </div>
  <div class="pic_middle">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-21.jpg' caption="The 3 X wires (cols) and the 4 Y wires (rows) connected to the breadboard." %}
  </div>
  <div class="pic_right">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-22.jpg' caption="Digital pins 6-8 used as outputs (cols, X), digital pins 9-12 used as inputs (rows, Y). Some 10-15k pull-down resistors to keep LOW level when no buttons are pressed." %}
  </div>
</div>

<div class="pic_row_3">
  <div class="pic_left">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-23.jpg' caption="Much later on I decided to get rid of the pull-down resistors by making everything low-active. More on that further below..." %}
  </div>
  <div class="pic_middle">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-24.jpg' caption="Had to fix the matrix, for some reason in the last row, two pins where not connected as I supposed they would be (* and 0)." %}
  </div>
  <div class="pic_right">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-25.jpg' caption="Removed the jumper pin-header that used to be here. It could be set/unset to change the phones behaviour. I just hard-wired it to stay closed." %}
  </div>
</div>


<a name="receiving">
### Receiving the input

I decided to not copy tons of code to this site but leave it where it's supposed to be: github ;-) I will post links to fully working code checkouts and to the diffs and commit messages that describe what each commit does or what I changed.

Let's check if the matrix works and we actually understand what we are doing here with this [test sketch](https://github.com/JOJ0/matrixmidi/blob/e61bf0bfa955ecbeaa0f45649f630d2f4a837dd8/matrixmidi.ino). Read the [commit message](https://github.com/JOJ0/matrixmidi/commit/e61bf0bfa955ecbeaa0f45649f630d2f4a837dd8) for instructions how to use it.

FIXME

note:
first:
yes it's high: 0 0
last:
yes it's high: 2 3


FIXME

## Finalizing

<a name="sticking">
### Mounting the keypad to the case

<div class="pic_row_3">
  <div class="pic_left">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-27.jpg' caption="The hot-glue idea went back to be double-sided scotch tape. I found this so-called mounting-tape somewhere and thought I give it a try." %}
  </div>
  <div class="pic_middle">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-28.jpg' caption="I used two layers of tape, except on the places where the wires are. I guessed that they'd need about 1 layer of thickness." %}
  </div>
  <div class="pic_right">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-29.jpg' caption="Well, in the right half of the case where the 4 row wires are, I messed it up a little, there should have been only 1 layer of tape. Looks and feels pretty steady anyway." %}
  </div>
</div>

<a name="usb-midi">
### The cheapest USB-MIDI-Arduino available

As mentioned at the very [top](#top) of this post, most Arduinos are not capable of showing up as proper MIDI device in your computer's operating system. If you are fine with using a software MIDI bridge like the [hairless MIDI bridge](http://projectgus.github.io/hairless-midiserial/), just look at the first picture in this chapter and you are done.

If it is not, one of the cheapest solutions around is to steal the electronics out of a USB to MIDI Adapter cable. You can get them in Europe for about 7-10 €. Certainly if you order them in China, a few pieces of them will cost you almost nothing. And btw: These cheap adapter cables are pretty useless for serious MIDI applications like controlling a synth from your your DAW. They are built so cheap, they literally loose data! Believe me, I measured it. But they are definitely good enough to be used for sending some knob or button movement aka some MIDI CC bytes. That's only a tiny amount of data and my experience is that they handle that savely.

<div class="pic_row_3">
  <div class="pic_left">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-30.jpg' caption="I decided to use a fresh Arduino Nano, solder the wires directly to it and keep the pin-headered Nano for breadboarding purposes. The 7 keypad wires are connected to digital pins, the USB port transports power and serial data. This is the final software simulated MIDI variant." %}
  </div>
  <div class="pic_middle">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-31.jpg' caption="To make the Nano a fully fledged USB-MIDI device I'll (mis)use this cheap USB-MIDI adapter cable." %}
  </div>
  <div class="pic_right">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-33.jpg' caption="It could be easily opened by poking around on the edges with a screwdriver. Some versions of these adapter cables are easier to forcefully open than other's ;-) Good luck with yours!" %}
  </div>
</div>

<div class="pic_row_3">
  <div class="pic_left">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-34.jpg' caption="This is where the MIDI-in and MIDI-out DIN jacks are connected. We are interested in the wires that connect the MIDI-INPUT port: IN- (black) and GND (red). Now please don't ask me why they chose to use a red wire for GND!?!" %}
  </div>
  <div class="pic_middle">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-36.jpg' caption="Original wires desoldered and hooked up to the Nano. Green wire: Nano TX1 to Adapter-PCB IN-, black wire: Nano GND to Adapter-PCB GND. Now recap the signal path when a button is pressed: Arduino sends OUT (TX1) data INTO (IN-) the adapter thing. ..." %}
  </div>
  <div class="pic_right">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-37.jpg' caption="... The adapter thing sends the data INTO the computers USB port. Makes sense? If your chosen case allows it, leave the USB side connected as is. ..." %}
  </div>
</div>

<div class="pic_row_3">
  <div class="pic_left">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-39.jpg' caption="... In my case I had to desolder it to nicely bring it into the case. I also reused the original strain relief plastic thing. Had to cut it a little to get it into my boxes hole." %}
  </div>
  <div class="pic_middle">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-41.jpg' caption="Soldered on four fresh wires of the same color to the PCB. Note that I chose the opposite direction for my solder joints as it originally was. Helps when putting in the whole PCB into a bag for isolation." %}
  </div>
  <div class="pic_right">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-42.jpg' caption="Checking if everything still would fit in. Only thing left to do is connecting the four wires to the USB-cable" %}
  </div>
</div>


<div class="pic_row_3">
  <div class="pic_left">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-43.jpg' caption="Decided to connect the red 5V wire of the Adapter-PCB directly to the Arduino's VIN pin first, ..." %}
  </div>
  <div class="pic_middle">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-44.jpg' caption="... and then via the 5V pin to the USB cable's red wire (V+, Vss). The attentive reader now would say that it would be more logic if I would've exchanged VIN and 5V on the Arduino. Well, that's true, but in the end 5V and VIN are exactely the same :-)" %}
  </div>
  <div class="pic_right">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-45.jpg' caption="Finally soldering all the freshly hooked on wires from the Adapter-PCB's USB-side to the original USB-cable again (and certainly the red wire coming from Nano 5V pin I just mentioned)." %}
  </div>
</div>

<div class="pic_row_3">
  <div class="pic_left">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-46.jpg' caption="Isolating the solder joints with shrink tube." %}
  </div>
  <div class="pic_middle">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-47.jpg' caption="Mounting it together. We are looking good, but I forgot a couple of things so I had to reopen it ;-)" %}
  </div>
  <div class="pic_right">
  </div>
</div>

<a name="testrun">
### Testrun

Now that we don't have to use the hairless MIDI bridge anymore, we change the mode of the program to send native MIDI speed (31250 bps) out of the Arduinos TX1 pin:

[Line 10](https://github.com/JOJ0/matrixmidi/blob/master/matrixmidi.ino#L10)

<div class="pic_row_3">
  <div class="pic_left">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-48.jpg' caption="Flashing the final program to the fresh Arduino via the black USB cable connected to the original Arduino's USB port. Notice that the silver USB cable is not connected to the computers's USB-port at this moment because I think it's not a good idea if two power sources were connected at once. So watch out!!!" %}
  </div>
  <div class="pic_middle">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-49.jpg' caption="That's when I relized that the red power LED's of the Arduino and the Adapter-PCB are shining through the orange case heavily. Nice!" %}
  </div>
  <div class="pic_right">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-50.jpg' caption="Left is the Adapter-PCB's LED and right the Arduino's tiny but pretty bright SMD-LED. This certainly brings up new ideas..." %}
  </div>
</div>


{% include youtube.html id="C4flMBFiFPc" url_append="" %}
The Nano's onboard LEDs and the Adapter-PCB's MIDI-IN LED should blink shortly when MIDI data is transmitted from the controller.
<br><br>

<a name="fancy">
### Making it even fancier

I had 5 digital pins left on the Arduino Nano, let's use them!

<div class="pic_row_3">
  <div class="pic_left">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-51.jpg' caption="One 2,2k resistor hooked up to GND will be used to limit current for 5 white LEDs." %}
  </div>
  <div class="pic_middle">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-52.jpg' caption="Connecting the resistor with 5 wires going to the LEDs cathode pins." %}
  </div>
  <div class="pic_right">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-53.jpg' caption="Soldering together this amount of wires sometimes is a bit challenging but if you just do it once and make sure you would never have to resolder this exact joint, IMHO it's an OK solution." %}
  </div>
</div>

<div class="pic_row_3">
  <div class="pic_left">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-54.jpg' caption="Shrink tube for isolation." %}
  </div>
  <div class="pic_middle">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-55.jpg' caption="The 5 white LEDs connected to the resistor (hidden in the shadows and shrink-tubed already). Orange wires are, you guessed it, the LEDs anodes, ..." %}
  </div>
  <div class="pic_right">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-56.jpg' caption="... which were connected to the 5 remaining digital pins (D1-D5)." %}
  </div>
</div>

<div class="pic_row_3">
  <div class="pic_left">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-57.jpg' caption="Alright, it's getting packed in there ;-)" %}
  </div>
  <div class="pic_middle">
  </div>
  <div class="pic_right">
  </div>
</div>

Just a little addition to the code:

FIXME

{% include youtube.html id="4g5KznbCrjw" url_append="?start=2490" width="100%" %}
FIXME
<br><br>


<div class="pic_row_3">
  <div class="pic_left">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-58.jpg' caption="" %}
  </div>
  <div class="pic_middle">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-59.jpg' caption="" %}
  </div>
  <div class="pic_right">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-60.jpg' caption="" %}
  </div>
</div>


<div class="pic_row_3">
  <div class="pic_left">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-61.jpg' caption="" %}
  </div>
  <div class="pic_middle">
    {% include thumb.html filename='/images/2018-11-17-midictrl1/matrixmidi-62.jpg' caption="" %}
  </div>
  <div class="pic_right">
  </div>
</div>

## Using it

{% include youtube.html id="sDhxnpLm9js" url_append="" %}
FIXME MIDI mapping in Ableton Live
<br><br>


### Getting supplies

[20 pin inline socket](https://www.musikding.de/20-Pin-inline-socket)<br>

FIXME
